generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String         @id @default(uuid())
  email              String         @unique
  passwordHash       String
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  subscriptionStatus String         @default("free")
  fcmToken           String?
  assets             Asset[]
  alerts             Alert[]
  subscription       Subscription?

  @@index([email])
}

model Asset {
  id           String    @id @default(uuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         String
  name         String
  ticker       String?
  quantity     Decimal?  @db.Decimal(18, 8)
  manualValue  Decimal?  @db.Decimal(18, 2)
  costBasis    Decimal?  @db.Decimal(18, 2)
  currency     String    @default("USD")
  country      String?
  sector       String?
  riskCategory String?
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  alerts       Alert[]

  @@index([userId])
  @@index([ticker])
}

model Price {
  id            String   @id @default(uuid())
  ticker        String
  assetType     String
  currency      String   @default("USD")
  provider      String
  price         Decimal  @db.Decimal(18, 8)
  change        Decimal? @db.Decimal(18, 8)
  changePercent Decimal? @db.Decimal(8, 4)
  previousClose Decimal? @db.Decimal(18, 8)
  fetchedAt     DateTime @default(now())

  @@unique([ticker, assetType, currency])
  @@index([ticker])
  @@index([fetchedAt])
}

model Alert {
  id           String    @id @default(uuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  assetId      String?
  asset        Asset?    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  type         String    // price_above, price_below, date_reminder, recurring_reminder
  triggerValue Decimal?  @db.Decimal(18, 8) // Price threshold for price alerts
  message      String
  nextFire     DateTime? // Next scheduled fire time
  rrule        String?   // iCal RRULE for recurring alerts
  enabled      Boolean   @default(true)
  lastFired    DateTime? // Last time this alert fired
  createdAt    DateTime  @default(now())

  @@index([userId])
  @@index([assetId])
  @@index([nextFire])
  @@index([enabled])
  @@index([type])
}

model Subscription {
  id           String    @id @default(uuid())
  userId       String    @unique
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  revenuecatId String    @unique
  status       String
  plan         String?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([revenuecatId])
}
